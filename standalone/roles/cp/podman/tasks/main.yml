---
- name: Check podman package installation
  shell: dpkg -l | grep podman | awk '{print $2}'
  register: podman_install

- name: Install podman package
  shell: |
    echo 'deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_20.04/ /' | tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
    curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_20.04/Release.key | apt-key add -
    apt-get update
    echo 'N\nN' > tmp_podman
    apt-get install -y podman < tmp_podman
  when: podman_install.stdout == ""

- name: Delete tmp file
  file:
    path: "tmp_podman"
    state: absent

- name: Get ingress-nginx-controller external ip
  become: false
  shell: kubectl get svc ingress-nginx-controller -n ingress-nginx | awk 'NR == 2 {print $4}'
  register: external_ip

- name: Add registries.conf
  shell: |
    cat <<EOF > /etc/containers/registries.conf.d/10-harbor.{{ external_ip.stdout }}.nip.io.conf
    [[registry]]
    prefix = "harbor.{{ external_ip.stdout }}.nip.io"
    insecure = true
    blocked = false
    location = "harbor.{{ external_ip.stdout }}.nip.io"
    EOF

- name: Restart podman service
  shell: systemctl restart podman
